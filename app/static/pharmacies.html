<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Pharmacies Near Me • Medication Interaction Verifier</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<style>
:root{ --bg:#3e787b; --panel:#2d5f61; --text:#fff; --muted:#e4e0dd; }
*{box-sizing:border-box}
html,body{height:100%}
body{ margin:0; font-family:'Montserrat', sans-serif; background:linear-gradient(135deg,#3e787b,#1f4d4f); color:var(--text); }

nav{ position:fixed;top:12px;left:50%;transform:translateX(-50%);display:flex;gap:12px;z-index:1000; }
nav a.btn{ text-decoration:none;padding:8px 14px;border-radius:25px;background:var(--panel);color:#fff;font-weight:600; }

.wrap{ max-width:1100px; margin:80px auto 24px; padding:0 16px; }
h1{ margin:0 0 12px; font-weight:700; }
.lead{ opacity:.95; max-width:800px; line-height:1.6; }

.toolbar{ display:flex; gap:10px; flex-wrap:wrap; margin:14px 0; }
.btn{ padding:10px 16px; border-radius:25px; border:none; background:var(--panel); color:#fff; cursor:pointer; font-weight:600; }
.input{ padding:10px 12px; border-radius:12px; border:none; background:var(--muted); color:#333; }

.grid{ display:grid; grid-template-columns: 1fr 360px; gap:16px; }
@media (max-width: 980px){ .grid{ grid-template-columns: 1fr; } }

#map{ width:100%; height:60vh; border-radius:16px; box-shadow:0 6px 16px rgba(0,0,0,.25); }
.panel{ background:rgba(255,255,255,.08); border-radius:16px; padding:12px; max-height:60vh; overflow:auto; }
.item{ background:rgba(255,255,255,.06); padding:10px; border-radius:12px; margin:8px 0; }
.item h3{ margin:0 0 6px; font-size:16px; }
.meta{ font-size:13px; opacity:.9; }
.badge{ padding:2px 8px; border-radius:10px; background:rgba(255,255,255,.18); margin-left:6px; }
.small{ display:block; opacity:.8; margin-top:10px; }
</style>
</head>
<body>
  <nav>
    <a href="/" class="btn">Home</a>
    <a href="/static/rules.html" class="btn">Rules</a>
    <a href="/static/history.html" class="btn">History</a>
    <a href="/static/pharmacies.html" class="btn">Pharmacies</a>
  </nav>

  <main class="wrap">
    <header>
      <h1>Pharmacies Near Me</h1>
      <p class="lead">Find open pharmacies around your current location. Uses OpenStreetMap data—no sign-ups or keys needed.</p>
    </header>

    <div class="toolbar">
      <button id="btnLocate" class="btn">Use my location</button>
      <label>Radius (meters): <input id="radius" class="input" type="number" value="2000" min="200" max="10000" style="width:110px"></label>
      <button id="btnRefresh" class="btn">Refresh list</button>
    </div>

    <div class="grid">
      <div id="map"></div>
      <aside class="panel">
        <div id="status" class="small">Click “Use my location” to start.</div>
        <div id="list"></div>
      </aside>
    </div>

    <footer class="small">Tip: Geolocation requires HTTPS or <code>localhost</code>. OpenStreetMap © contributors.</footer>
  </main>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script>
const API_OVERPASS = "https://overpass-api.de/api/interpreter";
let map, userMarker, pharmacyLayer;
let userPos = null;

function initMap(){
  map = L.map('map', { zoomControl: true });
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap'
  }).addTo(map);
  pharmacyLayer = L.layerGroup().addTo(map);
  // Default view (Europe)
  map.setView([40.4168, -3.7038], 13); // Madrid center as a friendly default
}
initMap();

document.getElementById('btnLocate').addEventListener('click', getLocation);
document.getElementById('btnRefresh').addEventListener('click', ()=>{
  if(!userPos){ setStatus("Please get your location first."); return; }
  fetchPharmacies();
});

function setStatus(msg){ document.getElementById('status').textContent = msg; }

function getLocation(){
  if(!navigator.geolocation){
    setStatus("Geolocation not supported by your browser.");
    return;
  }
  setStatus("Locating…");
  navigator.geolocation.getCurrentPosition(
    (pos)=>{
      const { latitude, longitude } = pos.coords;
      userPos = { lat: latitude, lon: longitude };
      if(userMarker){ map.removeLayer(userMarker); }
      userMarker = L.marker([latitude, longitude], { title:"You are here" }).addTo(map);
      map.setView([latitude, longitude], 15);
      fetchPharmacies();
    },
    (err)=>{
      setStatus("Unable to retrieve your location: " + err.message);
    },
    { enableHighAccuracy:true, timeout: 10000, maximumAge: 30000 }
  );
}

async function fetchPharmacies(){
  const radius = Number(document.getElementById('radius').value) || 2000;
  setStatus(`Searching pharmacies within ${radius} m…`);
  pharmacyLayer.clearLayers();
  document.getElementById('list').innerHTML = "";

  // Overpass query: nodes/ways/relations tagged amenity=pharmacy around point
  const query = `
    [out:json][timeout:25];
    (
      node["amenity"="pharmacy"](around:${radius},${userPos.lat},${userPos.lon});
      way["amenity"="pharmacy"](around:${radius},${userPos.lat},${userPos.lon});
      relation["amenity"="pharmacy"](around:${radius},${userPos.lat},${userPos.lon});
    );
    out center tags;
  `;

  try{
    const r = await fetch(API_OVERPASS, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8' },
      body: new URLSearchParams({ data: query })
    });
    if(!r.ok) throw new Error(`Overpass HTTP ${r.status}`);
    const data = await r.json();
    const places = (data.elements || []).map(e=>{
      const lat = e.lat ?? e.center?.lat;
      const lon = e.lon ?? e.center?.lon;
      return {
        id: e.id,
        name: e.tags?.name || "Pharmacy",
        addr: formatAddress(e.tags),
        lat, lon,
        phone: e.tags?.phone || e.tags?.["contact:phone"] || null,
        opening_hours: e.tags?.opening_hours || null,
        distance: userPos ? haversine(userPos.lat, userPos.lon, lat, lon) : null
      };
    }).filter(p=>p.lat && p.lon);

    places.sort((a,b)=>(a.distance??1e9)-(b.distance??1e9));
    renderMarkers(places);
    renderList(places);
    setStatus(`Found ${places.length} pharmacies.`);
  }catch(err){
    console.error(err);
    setStatus("Failed to load pharmacies: " + err.message);
  }
}

function renderMarkers(places){
  places.forEach(p=>{
    const m = L.marker([p.lat, p.lon]).bindPopup(`
      <strong>${escapeHtml(p.name)}</strong><br>
      ${escapeHtml(p.addr)}<br>
      ${p.opening_hours ? `Hours: ${escapeHtml(p.opening_hours)}<br>` : ""}
      ${p.phone ? `Phone: <a href="tel:${encodeURIComponent(p.phone)}">${escapeHtml(p.phone)}</a><br>` : ""}
      <a target="_blank" rel="noopener" href="${mapsLink(p.lat, p.lon)}">Open in Maps</a>
    `);
    m.addTo(pharmacyLayer);
  });
}

function renderList(places){
  const list = document.getElementById('list');
  if(!places.length){
    list.innerHTML = "<div class='item'>No pharmacies found in this radius.</div>";
    return;
  }
  list.innerHTML = places.map(p=>`
    <div class="item">
      <h3>${escapeHtml(p.name)} <span class="badge">${p.distance ? p.distance.toFixed(0)+" m" : ""}</span></h3>
      <div class="meta">${escapeHtml(p.addr)}</div>
      ${p.opening_hours ? `<div class="meta">Hours: ${escapeHtml(p.opening_hours)}</div>` : ""}
      ${p.phone ? `<div class="meta">Phone: <a href="tel:${encodeURIComponent(p.phone)}">${escapeHtml(p.phone)}</a></div>` : ""}
      <div style="margin-top:6px;">
        <a class="btn" style="text-decoration:none;padding:6px 10px;border-radius:10px;" target="_blank" rel="noopener" href="${mapsLink(p.lat,p.lon)}">Open in Maps</a>
        <button class="btn" style="padding:6px 10px;border-radius:10px;margin-left:6px;" onclick="flyTo(${p.lat},${p.lon})">Show on map</button>
      </div>
    </div>
  `).join("");
}

function flyTo(lat, lon){
  map.flyTo([lat, lon], 17, { duration: .6 });
}

function formatAddress(tags={}){
  const parts = [
    tags["addr:street"], tags["addr:housenumber"], tags["addr:postcode"], tags["addr:city"]
  ].filter(Boolean);
  return parts.join(", ") || (tags["addr:full"] || "");
}

function mapsLink(lat, lon){
  // Works on desktop & mobile; users choose Maps app automatically
  return `https://www.google.com/maps/search/?api=1&query=${lat},${lon}`;
}

function haversine(lat1, lon1, lat2, lon2){
  const toRad = d => d*Math.PI/180;
  const R = 6371000; // meters
  const dLat = toRad(lat2-lat1), dLon = toRad(lon2-lon1);
  const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

function escapeHtml(s){ return (s??"").toString()
  .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
  .replace(/"/g,"&quot;").replace(/'/g,"&#39;"); }
</script>
</body>
</html>
